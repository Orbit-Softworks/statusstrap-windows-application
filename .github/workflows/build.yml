name: Build and Release

on: 
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
      
    - name: Install and Build
      run: |
        # Force npm to ignore package-lock.json
        npm config set package-lock false
        
        # Clean install without package-lock
        npm install --no-package-lock
        
        # Build and publish the app with all auto-updater files
        npx electron-builder --win --publish always
        
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Verify Auto-Updater Files
      run: |
        echo "Checking for auto-updater files..."
        if (Test-Path "dist/latest.yml") {
          echo "✓ latest.yml exists"
          Get-Content dist/latest.yml
        } else {
          echo "✗ latest.yml missing!"
        }
        
        if (Test-Path "dist/*.exe") {
          echo "✓ Installer exists"
          Get-ChildItem dist/*.exe | ForEach-Object { echo "  - $_" }
        } else {
          echo "✗ Installer missing!"
        }
        
        if (Test-Path "dist/*.exe.blockmap") {
          echo "✓ Blockmap exists"
          Get-ChildItem dist/*.exe.blockmap | ForEach-Object { echo "  - $_" }
        } else {
          echo "✗ Blockmap missing!"
        }
