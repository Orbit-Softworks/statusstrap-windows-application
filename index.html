<script>
    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', async () => {
        // Simulate loading
        simulateLoading();
        
        // Initialize app
        await initializeApp();
    });

    // Loading simulation
    function simulateLoading() {
        let progress = 0;
        const progressBar = document.getElementById('loadingProgress');
        const loadingText = document.getElementById('loadingText');
        
        const interval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
                
                progressBar.style.width = '100%';
                loadingText.textContent = 'Ready';
                
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    initializeAnimations();
                }, 800);
            } else {
                progressBar.style.width = `${progress}%`;
                loadingText.textContent = `Loading ${Math.floor(progress)}%`;
            }
        }, 100);
    }

    // Initialize app
    async function initializeApp() {
        // Get data from main process
        const { bootstrappers, mods } = window.electron.getBootstrappers();
        
        // Initialize stats
        initializeStats(bootstrappers, mods);
        
        // Initialize bootstrappers
        initializeBootstrappers(bootstrappers);
        
        // Initialize mods
        initializeMods(mods);
        
        // Initialize contributors
        initializeContributors();
        
        // Start auto-update checks
        startAutoUpdateChecks();
        
        // Load stored versions
        loadStoredVersions();
        
        // Listen for bootstrapper updates from main process
        window.electron.onBootstrapperUpdated((data) => {
            console.log('Bootstrapper updated:', data);
            showUpdateNotification(data.title, 'Unknown', data.version);
        });
    }

    // Initialize statistics
    function initializeStats(bootstrappers, mods) {
        const stats = {
            total: bootstrappers.length + mods.length,
            windows: [...bootstrappers, ...mods].filter(item => item.platform === "Windows").length,
            android: [...bootstrappers, ...mods].filter(item => item.platform === "Android").length,
            macos: [...bootstrappers, ...mods].filter(item => item.platform === "MacOS").length,
            ios: [...bootstrappers, ...mods].filter(item => item.platform === "iOS").length,
            linux: [...bootstrappers, ...mods].filter(item => item.platform === "Linux").length,
        };

        const statItems = [
            { 
                label: "Total Launchers", 
                value: stats.total, 
                icon: "https://i.ibb.co/zTFZDhbR/status-strap-christmas-b.png"
            },
            { 
                label: "Windows", 
                value: stats.windows, 
                icon: "https://upload.wikimedia.org/wikipedia/commons/8/87/Windows_logo_-_2021.svg"
            },
            { 
                label: "Android", 
                value: stats.android, 
                icon: "https://upload.wikimedia.org/wikipedia/commons/d/d7/Android_robot.svg"
            },
            { 
                label: "MacOS", 
                value: stats.macos, 
                icon: "https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg"
            },
            { 
                label: "iOS", 
                value: stats.ios, 
                icon: "https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg"
            },
            { 
                label: "Linux", 
                value: stats.linux, 
                icon: "https://upload.wikimedia.org/wikipedia/commons/3/35/Tux.svg"
            },
        ];

        const statsGrid = document.getElementById('statsGrid');
        statsGrid.innerHTML = statItems.map(stat => `
            <div class="stat-card">
                <div class="stat-icon">
                    <img src="${stat.icon}" alt="${stat.label}">
                </div>
                <div class="stat-value">${stat.value}</div>
                <div class="stat-label">${stat.label}</div>
            </div>
        `).join('');
    }

    // Initialize bootstrappers
    function initializeBootstrappers(bootstrappers) {
        const grid = document.getElementById('bootstrappersGrid');
        grid.innerHTML = bootstrappers.map((item, index) => createCardHTML(item, index)).join('');
        
        // Load GitHub data for each bootstrapper
        bootstrappers.forEach((item, index) => {
            if (item.githubRepo) {
                fetchGitHubData(item, index, 'bootstrapper');
            }
        });
    }

    // Initialize mods
    function initializeMods(mods) {
        const grid = document.getElementById('modsGrid');
        grid.innerHTML = mods.map((item, index) => createCardHTML(item, index)).join('');
        
        // For mods without GitHub repos, set default values
        mods.forEach((item, index) => {
            if (!item.githubRepo) {
                const versionElement = document.getElementById(`version-${index + bootstrappers.length}`);
                const updatedElement = document.getElementById(`updated-${index + bootstrappers.length}`);
                if (versionElement) versionElement.textContent = 'Manual';
                if (updatedElement) updatedElement.textContent = 'Manual Update';
            }
        });
    }

    // Create card HTML
    function createCardHTML(item, index) {
        const isDisabled = !item.working;
        const typeClass = item.type === "Mod" ? "mod" : "";
        
        return `
            <div class="card ${isDisabled ? 'disabled' : ''}" id="card-${index}">
                ${item.isPrerelease ? '<div class="prerelease-banner">PRE-RELEASE</div>' : ''}
                
                <div class="card-header">
                    <div class="card-icon">
                        <img src="${item.image}" alt="${item.title}" onerror="this.src='https://i.ibb.co/zTFZDhbR/status-strap-christmas-b.png'">
                    </div>
                    <div class="card-title">
                        <h3>${item.title}</h3>
                        <div class="card-tags">
                            ${item.tags.map(tag => `
                                <span class="tag ${tag === 'Recommended' ? 'recommended' : 'regular'}">${tag}</span>
                            `).join('')}
                        </div>
                    </div>
                    <div class="card-badges">
                        <span class="badge version" id="version-${index}">Loading...</span>
                        <span class="badge status ${isDisabled ? 'offline' : ''}">${isDisabled ? 'OFFLINE' : 'WORKING'}</span>
                        <span class="badge type ${typeClass}">${item.type}</span>
                    </div>
                </div>
                
                <p class="card-description">${item.description || 'No description available.'}</p>
                
                <div class="card-stats">
                    <div class="stat-item">
                        <div class="stat-label">Platform</div>
                        <div class="stat-value">${item.platform}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Updated</div>
                        <div class="stat-value" id="updated-${index}">Loading...</div>
                    </div>
                </div>
                
                <div class="card-actions">
                    <button class="download-button" onclick="downloadBootstrapper(${index})" ${isDisabled ? 'disabled' : ''}>
                        <img src="https://cdn-icons-png.flaticon.com/512/724/724933.png" alt="Download" style="width: 16px; height: 16px;">
                        Download
                    </button>
                    <div class="button-row">
                        ${item.discord ? `
                            <button class="secondary-button" onclick="joinDiscord('${item.discord}')" ${isDisabled ? 'disabled' : ''}>
                                <img src="https://cdn-icons-png.flaticon.com/512/5968/5968756.png" alt="Discord" style="width: 16px; height: 16px;">
                                Discord
                            </button>
                        ` : ''}
                        ${item.githubRepo ? `
                            <button class="secondary-button" onclick="openGitHub('${item.githubRepo}')" ${isDisabled ? 'disabled' : ''}>
                                <img src="https://cdn-icons-png.flaticon.com/512/25/25231.png" alt="GitHub" style="width: 16px; height: 16px;">
                                GitHub
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    // Initialize contributors
    function initializeContributors() {
        const contributors = [
            { 
                name: "Smilez", 
                role: "StatusStrap Founder & Dev",
                avatar: "https://i.ibb.co/chtLPThG/smilez.png" 
            },
            { 
                name: "ð“ˆð“ƒð’¶ð“€ð“", 
                role: "OG Admin (Been There Since Day 1)", 
                avatar: "https://i.ibb.co/d4QLKR3f/snakz.png" 
            },
            { 
                name: "Caleb", 
                role: "Admin", 
                avatar: "https://i.ibb.co/PzMF78CC/caleb.png" 
            },
            { 
                name: "qu7s", 
                role: "Domain Hoster", 
                avatar: "https://i.ibb.co/qMPHrFSy/qu7s.png" 
            },
            { 
                name: "xnox67", 
                role: "Domain Hoster", 
                avatar: "https://i.ibb.co/ZR73b443/xnox67.png" 
            },
        ];

        const grid = document.getElementById('contributorsGrid');
        grid.innerHTML = contributors.map(contributor => `
            <div class="contributor-card">
                <div class="contributor-avatar">
                    <img src="${contributor.avatar}" alt="${contributor.name}" onerror="this.src='https://i.ibb.co/zTFZDhbR/status-strap-christmas-b.png'">
                </div>
                <div class="contributor-name">${contributor.name}</div>
                <div class="contributor-role">${contributor.role}</div>
            </div>
        `).join('');
    }

    // Fetch GitHub data
    async function fetchGitHubData(item, index, type) {
        try {
            const versionElement = document.getElementById(`version-${index}`);
            const updatedElement = document.getElementById(`updated-${index}`);
            
            versionElement.textContent = 'Fetching...';
            updatedElement.textContent = 'Fetching...';
            
            const response = await window.electron.fetchGitHubRelease(item.githubRepo);
            if (response.data && response.data.success) {
                versionElement.textContent = response.data.version;
                updatedElement.textContent = response.data.lastUpdated;
                
                // Check for updates
                checkForUpdate(item.title, response.data.version, response.data.description, item.platform, item.image, response.data.isPrerelease);
                
                // Update prerelease banner if needed
                if (response.data.isPrerelease) {
                    const card = document.getElementById(`card-${index}`);
                    if (!card.querySelector('.prerelease-banner')) {
                        const banner = document.createElement('div');
                        banner.className = 'prerelease-banner';
                        banner.textContent = 'PRE-RELEASE';
                        card.prepend(banner);
                    }
                }
            } else {
                versionElement.textContent = 'Error';
                updatedElement.textContent = 'Check GitHub';
            }
        } catch (error) {
            console.error('Error fetching GitHub data:', error);
            const versionElement = document.getElementById(`version-${index}`);
            const updatedElement = document.getElementById(`updated-${index}`);
            versionElement.textContent = 'Error';
            updatedElement.textContent = 'Check GitHub';
        }
    }

    // Check for updates
    async function checkForUpdate(title, version, description, platform, image, isPrerelease) {
        const storedVersions = window.electron.getStoredVersions();
        const oldVersion = storedVersions[title] || "Unknown";
        
        if (oldVersion !== version && 
            version !== "Unknown" && 
            version !== "Error" && 
            version !== "No Releases") {
            
            // Update stored version
            storedVersions[title] = version;
            window.electron.saveVersions(storedVersions);
            
            // Show notification
            showUpdateNotification(title, oldVersion, version);
            
            // Send Discord notification
            try {
                await window.electron.sendDiscordNotification(title, oldVersion, version, description, platform, image, isPrerelease);
            } catch (error) {
                console.error('Error sending Discord notification:', error);
            }
        }
    }

    // Show update notification
    function showUpdateNotification(title, oldVersion, newVersion) {
        const notification = document.getElementById('updateNotification');
        notification.textContent = `${title} updated: ${oldVersion} â†’ ${newVersion}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 5000);
    }

    // Load stored versions
    function loadStoredVersions() {
        const storedVersions = window.electron.getStoredVersions();
        return storedVersions;
    }

    // Start auto-update checks
    function startAutoUpdateChecks() {
        // Update status text every minute
        setInterval(() => {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('statusText').textContent = `Active â€¢ Last: ${timeString}`;
        }, 60000);
    }

    // Initialize animations
    function initializeAnimations() {
        const cards = document.querySelectorAll('.card, .stat-card, .contributor-card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    }

    // Filter cards based on search
    function filterCards() {
        const searchInput = document.getElementById('searchInput');
        const query = searchInput.value.toLowerCase();
        
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            const title = card.querySelector('h3').textContent.toLowerCase();
            const description = card.querySelector('.card-description').textContent.toLowerCase();
            const tags = Array.from(card.querySelectorAll('.tag')).map(tag => tag.textContent.toLowerCase());
            
            const matches = title.includes(query) || 
                           description.includes(query) || 
                           tags.some(tag => tag.includes(query));
            
            card.style.display = matches ? 'block' : 'none';
        });
    }

    // Scroll to section
    function scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            const mainContent = document.getElementById('mainContent');
            const offsetTop = section.offsetTop - 80;
            mainContent.scrollTo({
                top: offsetTop,
                behavior: 'smooth'
            });
        }
    }

    // Download bootstrapper
    function downloadBootstrapper(index) {
        const { bootstrappers, mods } = window.electron.getBootstrappers();
        const allItems = [...bootstrappers, ...mods];
        const item = allItems[index];
        
        if (item && item.working) {
            window.electron.downloadBootstrapper(item);
        }
    }

    // Join Discord
    function joinDiscord(url) {
        window.electron.joinDiscord(url);
    }

    // Open GitHub
    function openGitHub(repo) {
        window.electron.openGitHub(repo);
    }

    // Open bootstrapper page
    function openBootstrapper(title) {
        const { bootstrappers, mods } = window.electron.getBootstrappers();
        const allItems = [...bootstrappers, ...mods];
        const item = allItems.find(i => i.title === title);
        
        if (item) {
            window.electron.openExternal(item.website);
        }
    }

    // Check for updates manually
    function checkForUpdates() {
        window.electron.checkUpdates();
    }

    // Expose functions to window
    window.scrollToSection = scrollToSection;
    window.filterCards = filterCards;
    window.downloadBootstrapper = downloadBootstrapper;
    window.joinDiscord = joinDiscord;
    window.openGitHub = openGitHub;
    window.openBootstrapper = openBootstrapper;
    window.checkForUpdates = checkForUpdates;
</script>
